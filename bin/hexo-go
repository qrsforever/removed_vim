#!/bin/bash

if (( $# != 2 ))
then
    exit 0
fi

fullpath=$1
pathdir=`dirname $fullpath`
fileME=`basename $fullpath`
current_dir=`dirname ${BASH_SOURCE[0]}`
current_dir=`cd $current_dir; pwd`

log_file=/tmp/hexo-go.log

echo "" > $log_file

# randnum=`date +%s%N`

destdir="$current_dir/../extern/git-blog-setting"
drafts="source/_drafts"

if [ ! -d "${destdir}/${drafts}" ]
then
    echo "mkdir -p ${destdir}/${drafts}" > $log_file
    mkdir -p ${destdir}/${drafts}
fi

if [[ x"md" != x${fileME##*.} ]]
then
    echo "file not md: $fileME" >> $log_file
    exit 0
fi

HEXO_CMD=`which hexo`

if [[ x$HEXO_CMD == x ]]
then
    echo "cmd not found: hexo" >> $log_file
    exit 0
fi

cd $destdir
killall hexo

if [[ $2 == 2 ]]
then
    echo "hexo clean" >> $log_file
    $HEXO_CMD clean
    rm -rf ${destdir}/${drafts}/*
    exit 0
else
    rm -rf "${destdir}/${drafts}/${fileME}"
    rm -rf ${destdir}/${drafts}/asset
fi
ln -s $fullpath ${destdir}/${drafts}/${fileME}

if [[ -d $pathdir/asset ]]
then
    ln -s $pathdir/asset ${destdir}/${drafts}/asset
fi

$HEXO_CMD g --draft 2>&1 | tee -a $log_file
$HEXO_CMD s --silent --draft &
sleep 3
if [[ $2 == 1 ]]
then
    # 10.58.82.240
    ip=`ifconfig | grep -a1 "eth0" | grep "inet addr" | cut -d\: -f2 | cut -d\  -f1`
    if [[ x$ip == x ]]
    then
        ip="localhost"
    fi
    xdg-open http://${ip}:4000
fi
cd - >/dev/null
