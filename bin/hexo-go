#!/bin/bash

if (( $# != 1 ))
then
    exit 0
fi

fullpath=$1
pathdir=`dirname $fullpath`
fileME=`basename $fullpath`
current_dir=`dirname ${BASH_SOURCE[0]}`
current_dir=`cd $current_dir; pwd`

destdir="$current_dir/../extern/git-blog-setting"
drafts="source/_drafts"

if [ ! -d "${destdir}/${drafts}" ]
then
    exit 0
fi

echo "$fullpath" > /tmp/log.txt
if [[ x"clean" == x$fullpath ]]
then
    rm -rf "${destdir}/${drafts}/*"
    exit 0
fi

if [[ x"md" != x${fileME##*.} ]]
then
    exit 0
fi

HEXO_CMD=`which hexo`

if [[ x$HEXO_CMD == x ]]
then
    exit 0
fi

cd $destdir
killall hexo

if [[ ! -L "${destdir}/${drafts}/${pathdir}/${fileME}" ]]
then
    mkdir -p ${destdir}/${drafts}/${pathdir}
    ln -s $fullpath ${destdir}/${drafts}/${pathdir}/${fileME}
fi

$HEXO_CMD g --silent --draft
$HEXO_CMD s --silent --draft &
sleep 3
# 10.58.82.240
ip=`ifconfig | grep -a1 "eth0" | grep "inet addr" | cut -d\: -f2 | cut -d\  -f1`
if [[ x$ip == x ]]
then
    ip="localhost"
fi
xdg-open http://${ip}:4000
cd - >/dev/null
